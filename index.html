<!DOCTYPE html>
<html>

<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
</head>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://rawgit.com/jasondavies/d3-cloud/master/build/d3.layout.cloud.js"></script>

<body>
  <content>

  </content>
  <script>

    //Based on https://github.com/jasondavies/d3-cloud/blob/master/examples/simple.html
    // Encapsulate the word cloud functionality
    function wordCloud(selector) {

      var fill = d3.scale.category20();
      //Construct the word cloud's SVG element
      var svg = d3.select(selector).append("svg")
        .attr("width", 1400)
        .attr("height", 700)
        .append("g")
        .attr("transform", "translate(700,350)");


      //Draw the word cloud
      function draw(words) {
        var cloud = svg.selectAll("g text")
          .data(words, function (d) { return d.text; })

        //Entering words
        cloud.enter()
          .append("text")
          .style("font-family", "Impact")
          .style("fill", function (d, i) { return fill(i); })
          .attr("text-anchor", "middle")
          .attr('font-size', 1)
          .text(function (d) { return d.text; });

        //Entering and existing words
        cloud
          .transition()
          .duration(600)
          .style("font-size", function (d) { return d.size + "px"; })
          .attr("transform", function (d) {
            return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
          })
          .style("fill-opacity", 1);

        //Exiting words
        cloud.exit()
          .transition()
          .duration(200)
          .style('fill-opacity', 1e-6)
          .attr('font-size', 1)
          .remove();
      }


      //Use the module pattern to encapsulate the visualisation code. We'll
      // expose only the parts that need to be public.
      return {

        //Recompute the word cloud for a new set of words. This method will
        // asycnhronously call draw when the layout has been computed.
        //The outside world will need to call this function, so make it part
        // of the wordCloud return value.
        update: function (words) {
          d3.layout.cloud().size([1400, 700])
            .words(words)
            .padding(5)
            .rotate(function () { return ~~(Math.random() * 2) * 90; })
            .font("Impact")
            .fontSize(function (d) { return d.size; })
            .on("end", draw)
            .start();
        }
      }
    }

    document.addEventListener('keydown', event => {
      if (event.keyCode === 81) {
        STATE_NAME = "QUOTATION";
      } else if (event.keyCode === 84) {
        STATE_NAME = "TEXT";
      } else if (event.keyCode === 87) {
        STATE_NAME = "WORDCLOUD";
      }
      LARGE_TRANSCRIPT = "";
      render_state();
    });

    function render_wordcloud() {
      document.getElementsByTagName("content")[0].innerHTML = ""
      const counts = {};
      for (const word of LARGE_TRANSCRIPT.split(' ')) {
        counts[word] = counts[word] ? counts[word] + 1 : 1;
      }
      var instructions = []
      for (const [key, value] of Object.entries(counts)) {
        instructions.push({ "text": key, "size": 30 + 20 * value })
      }
      wordCloud("content").update(instructions)
    }

    function render_quotation() {
      htmlStr = `
      <div class="container" id="quote-display">
      <div class="vertical-center"> 
        <blockquote>
          <i id = "quote-string"> ${LARGE_TRANSCRIPT} </i> 
          <br>
          <i id="quote-author">- Team ProcrastiPoint</i> 
        </blockquote>
      </div>
      </div>
      `;
      document.getElementsByTagName("content")[0].innerHTML = htmlStr;
    }

    function render_text() {
      words = LARGE_TRANSCRIPT.split('.');
      htmlStr = "<ul>"
      words.forEach(element => {
        htmlStr += "\n";
        htmlStr += "<li>"
        htmlStr += element
        htmlStr += "</li>"
      });
      htmlStr += "</ul>"
      document.getElementsByTagName("content")[0].innerHTML = htmlStr;
    }

    var STATE_NAME = "WORDCLOUD"
    var LARGE_TRANSCRIPT = ""

    function update_state(data) {
      if (data.channel.alternatives[0].transcript && data.is_final) {
        LARGE_TRANSCRIPT += ' ' + data.channel.alternatives[0].transcript
        console.log(LARGE_TRANSCRIPT)
        return true
      }
      return false
    }

    function render_state() {
      if (STATE_NAME == "WORDCLOUD") {
        render_wordcloud()
      } else if (STATE_NAME == "QUOTATION") {
        render_quotation()
      } else if (STATE_NAME == "TEXT") {
        render_text()
      }
    }

    navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
      console.log({ stream })
      if (!MediaRecorder.isTypeSupported('audio/webm'))
        return alert('Browser not supported')
      const mediaRecorder = new MediaRecorder(stream, {
        mimeType: 'audio/webm',
      })
      const socket = new WebSocket('wss://api.deepgram.com/v1/listen', [
        'token',
        'cb8b6618675735c7896101b9377f325f1a5a9e80',
      ])
      socket.onopen = () => {
        console.log({ event: 'onopen' })
        mediaRecorder.addEventListener('dataavailable', async (event) => {
          if (event.data.size > 0 && socket.readyState == 1) {
            socket.send(event.data)
          }
        })
        mediaRecorder.start(1000)
      }

      socket.onmessage = (message) => {
        const received = JSON.parse(message.data)
        if (update_state(received)) {
          render_state()
        };
      }

      socket.onclose = () => {
        console.log({ event: 'onclose' })
      }

      socket.onerror = (error) => {
        console.log({ event: 'onerror', error })
      }
    })
  </script>

  <style>
    blockquote {text-align: center;}
    .container {
      height: 200px;
      position: relative;
      border: 3px solid rgb(218, 122, 247);
      background-color: rgb(167, 236, 250);
    }

  .vertical-center {
  margin: 0;
  position: absolute;
  top: 50%;
  -ms-transform: translateY(-50%);
  transform: translateY(-50%);
}

#quote-string {
  font-size: 25px;
}
  </style>

</body>

</html>